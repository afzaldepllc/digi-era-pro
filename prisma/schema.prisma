// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

model Channel {
  id                    String   @id @default(uuid()) @db.Uuid
  type                  String   // 'dm' | 'group' | 'department' | 'project' | 'client-support'
  name                  String?  // Channel name (optional for DMs)
  avatar_url            String?  // Channel avatar URL
  mongo_department_id   String?  // MongoDB department reference
  mongo_project_id      String?  // MongoDB project reference
  mongo_creator_id      String   // MongoDB user ID of creator
  is_private            Boolean  @default(false) // Privacy setting
  member_count          Int      @default(0) // Number of members
  last_message_at       DateTime? // Last message timestamp
  created_at            DateTime @default(now()) @db.Timestamp(6)
  updated_at            DateTime @updatedAt @db.Timestamp(6)

  // Relations
  messages              Message[]
  channel_members       ChannelMember[]
  reactions             Reaction[]
  attachments           Attachment[]

  @@map("channels")
}

model Message {
  id                      String   @id @default(uuid()) @db.Uuid
  channel_id              String   @db.Uuid
  mongo_sender_id         String   // MongoDB user ID of sender
  content                 String   // Message content
  content_type            String   @default("text") // 'text' | 'file' | 'system'
  thread_id               String?  @db.Uuid // For threading (optional)
  reply_count             Int      @default(0) // Number of replies
  mongo_mentioned_user_ids String[] // Array of mentioned user IDs
  is_edited               Boolean  @default(false) // Edit status
  edited_at               DateTime? @db.Timestamp(6) // Edit timestamp
  created_at              DateTime @default(now()) @db.Timestamp(6)

  // Relations
  channel                 Channel     @relation(fields: [channel_id], references: [id], onDelete: Cascade)
  read_receipts           ReadReceipt[]
  reactions               Reaction[]
  attachments             Attachment[]

  @@map("messages")
}

model ChannelMember {
  id              String   @id @default(uuid()) @db.Uuid
  channel_id      String   @db.Uuid
  mongo_member_id String   // MongoDB user ID
  role            String   @default("member") // 'admin' | 'member' | 'guest'
  joined_at       DateTime @default(now()) @db.Timestamp(6)
  last_seen_at    DateTime? @db.Timestamp(6) // Last activity timestamp
  is_online       Boolean  @default(false) // Online status
  notifications_enabled Boolean @default(true) // Notification preferences

  // Relations
  channel         Channel  @relation(fields: [channel_id], references: [id], onDelete: Cascade)

  @@unique([channel_id, mongo_member_id])
  @@map("channel_members")
}

model ReadReceipt {
  id              String   @id @default(uuid()) @db.Uuid
  message_id      String   @db.Uuid
  mongo_user_id   String   // MongoDB user ID
  read_at         DateTime @default(now()) @db.Timestamp(6)

  // Relations
  message         Message  @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@unique([message_id, mongo_user_id])
  @@map("read_receipts")
}

model Reaction {
  id              String   @id @default(uuid()) @db.Uuid
  message_id      String   @db.Uuid
  channel_id      String   @db.Uuid
  mongo_user_id   String   // MongoDB user ID
  emoji           String   // Reaction emoji
  created_at      DateTime @default(now()) @db.Timestamp(6)

  // Relations
  message         Message  @relation(fields: [message_id], references: [id], onDelete: Cascade)
  channel         Channel  @relation(fields: [channel_id], references: [id], onDelete: Cascade)

  @@unique([message_id, mongo_user_id, emoji])
  @@map("reactions")
}

model Attachment {
  id                  String   @id @default(uuid()) @db.Uuid
  message_id          String   @db.Uuid
  channel_id          String   @db.Uuid
  mongo_uploader_id   String   // MongoDB user ID
  file_name           String   // Original file name
  file_url            String?  // File URL (if stored externally)
  s3_key              String?  // S3 key for file storage
  s3_bucket           String?  // S3 bucket name
  file_size           Int?     // File size in bytes
  file_type           String?  // MIME type
  created_at          DateTime @default(now()) @db.Timestamp(6)

  // Relations
  message             Message  @relation(fields: [message_id], references: [id], onDelete: Cascade)
  channel             Channel  @relation(fields: [channel_id], references: [id], onDelete: Cascade)

  @@map("attachments")
}
